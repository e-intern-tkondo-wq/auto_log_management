# 要求フロー vs 実装状況の比較

## ユーザー要求フロー

### 1. 正規表現テーブルを事前に作成し、既知判定
**要求**:
- 正規表現テーブルを事前に作成
- 流れてきたログとマッチすれば「既知」とする
- 入力のログをDBに入れ、既知判定フラグを立てる

**現在の実装状況**: ⚠️ **部分実装（60%）**

✅ **実装済み**:
- `regex_patterns` テーブルは存在
- ログとパターンのマッチング機能
- `pattern_id` で既知/未知を判断可能

❌ **未実装**:
- 事前に正規表現テーブルを作成する機能（現在は動的作成）
- `log_entries` テーブルに `is_known` フラグがない
- 既知判定の明示的なフラグ

**必要な修正**:
- `log_entries` テーブルに `is_known` カラムを追加
- 事前パターン登録機能の追加

---

### 2. 既知ログの異常/正常判定（パラメータ抽出含む）
**要求**:
- 既知と判断されたもののうち、異常系か正常系かを判断
- 特定の異常を表す正規表現とマッチすれば異常
- 正規表現のパラメータ部分（例: `\d+ °C` の `\d+` が100の場合）について異常が認められる場合に異常
- そうでなければ正常
- この判断を行うテーブルを作成

**現在の実装状況**: ⚠️ **部分実装（40%）**

✅ **実装済み**:
- `anomaly_detector.py` に異常判定ロジックあり
- `pattern_rules` テーブルの概念あり（ただし未使用）
- しきい値チェック機能あり

❌ **未実装**:
- `log_params` テーブルがない（パラメータ抽出結果を保存するテーブル）
- パラメータ抽出機能（named capture group からの抽出）
- インジェスト時の自動異常判定
- `pattern_rules` テーブルがデータベースに存在しない

**必要な修正**:
- `log_params` テーブルの追加
- パラメータ抽出機能の実装
- `pattern_rules` テーブルの追加
- インジェスト時に既知ログに対して異常判定を実行

---

### 3. 未知ログの手動マッピング
**要求**:
- 既知に分類されない（未知）ログについて
- 既知のログにほぼ同じような正規表現があれば、手動でその正規表現と対応させる
- 入力のログが入ったDBについて、既知フラグは立たなかったが、手動変更フラグを立て、対応する正規表現のIDと紐付ける

**現在の実装状況**: ⚠️ **部分実装（70%）**

✅ **実装済み**:
- `cli_tools.py update-label` でパターンラベルの更新可能
- 既存ログエントリの `classification` を自動更新

❌ **未実装**:
- `log_entries` テーブルに `is_manual_mapped` フラグがない
- 未知ログを既知パターンに手動で紐付ける機能（`pattern_id` の手動更新）
- 類似パターンの検索・提案機能

**必要な修正**:
- `log_entries` テーブルに `is_manual_mapped` カラムを追加
- 未知ログを既知パターンに手動紐付けする機能

---

### 4. 未知かつ正体不明ログのAI処理
**要求**:
- 上記全てに該当しない、つまり未知かつ正体不明のログについて
- 検索をかけたりgpt-ossなどのAIを利用したりして対処
- このエージェントはDBに自動格納することもできていてほしい

**現在の実装状況**: ❌ **未実装（0%）**

❌ **未実装**:
- AI（GPT-OSS等）への問い合わせ機能
- 検索機能
- AI分析結果のDB自動格納
- `ai_analyses` テーブルは定義されているが未使用

**必要な修正**:
- AI分析機能の実装
- `ai_analyses` テーブルの活用

---

### 5. 異常/正体不明ログのSlack通知
**要求**:
- 異常あるいは正体不明検知が行われた場合、Slackなどの外部ツールに連携

**現在の実装状況**: ✅ **実装済み（90%）**

✅ **実装済み**:
- `alerts` テーブルにアラート記録
- Slack Webhook への送信機能
- 送信成功/失敗の記録

⚠️ **改善点**:
- インジェスト時の自動送信（現在は別コマンドで実行）

---

## 実装状況サマリー

| 要求項目 | 実装状況 | 完了率 |
|---------|---------|--------|
| 1. 事前パターン登録と既知判定 | 部分実装 | 60% |
| 2. 既知ログの異常/正常判定 | 部分実装 | 40% |
| 3. 未知ログの手動マッピング | 部分実装 | 70% |
| 4. AI処理（未知かつ正体不明） | 未実装 | 0% |
| 5. Slack通知 | 実装済み | 90% |

**全体**: **約50% 実装完了**

---

## 必要な追加実装

### データベーススキーマの拡張

1. **`log_entries` テーブルに追加**:
   - `is_known` (INTEGER DEFAULT 0) - 既知判定フラグ
   - `is_manual_mapped` (INTEGER DEFAULT 0) - 手動マッピングフラグ

2. **`log_params` テーブルの追加**:
   - `id` (INTEGER PK)
   - `log_id` (INTEGER FK → log_entries.id)
   - `param_name` (TEXT) - パラメータ名
   - `param_value_num` (REAL) - 数値値
   - `param_value_text` (TEXT) - テキスト値

3. **`pattern_rules` テーブルの追加**:
   - `id` (INTEGER PK)
   - `pattern_id` (INTEGER FK → regex_patterns.id)
   - `rule_type` (TEXT) - 'threshold', 'contains', 'regex' など
   - `field_name` (TEXT) - パラメータ名
   - `op` (TEXT) - '>', '<', '==', 'between' など
   - `threshold_value1`, `threshold_value2` (REAL)
   - `severity_if_match` (TEXT)
   - `is_abnormal_if_match` (INTEGER DEFAULT 1)
   - `message` (TEXT) - 異常理由

### 機能追加

1. **事前パターン登録機能**
   - 正規表現パターンを事前に登録するコマンド/スクリプト

2. **パラメータ抽出機能**
   - named capture group からパラメータを抽出
   - `log_params` テーブルに保存

3. **異常判定の自動実行**
   - インジェスト時に既知ログに対して自動的に異常判定を実行

4. **手動マッピング機能**
   - 未知ログを既知パターンに手動で紐付ける機能
   - `is_manual_mapped` フラグの設定

5. **AI分析機能**
   - GPT-OSS等への問い合わせ
   - 分析結果のDB自動格納

---

## 結論

現在の実装は**基本的なフローは実装済み**ですが、ユーザーが要求する詳細な機能（パラメータ抽出、異常判定の自動実行、手動マッピング、AI処理）は**まだ実装されていません**。

特に重要なのは：
- パラメータ抽出機能（`log_params` テーブル）
- 異常判定の自動実行（`pattern_rules` テーブル）
- 手動マッピング機能（`is_manual_mapped` フラグ）
- AI分析機能

これらを実装することで、要求フローを完全に満たすことができます。

