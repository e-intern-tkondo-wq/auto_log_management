# 要求フロー vs 実装状況の比較
> このファイルで行うこと: 要求フローごとに実装済み/未実装の差分を整理します。

## ユーザー要求フロー

### 1. 正規表現テーブルを事前に作成し、既知判定
**要求**:
- 正規表現テーブルを事前に作成
- 流れてきたログとマッチすれば「既知」とする
- 入力のログをDBに入れ、既知判定フラグを立てる

**現在の実装状況**: ✅ **ほぼ実装済み（90%）**

✅ **実装済み**:
- `regex_patterns` テーブルと `add-pattern` CLI で事前登録が可能
- `log_entries` に `pattern_id` / `is_known` を保持し、既知/未知を明示
- 自動生成パターンと手動パターン（named capture対応）の両方を扱える

⚠️ **追加で検討したい点**:
- 代表テンプレの一括投入スクリプト（サンプルDBの初期化）
- 既知/未知の可視化ダッシュボード

**今後の改善案**:
- 主要テンプレ群をJSON等で配布し `add-pattern` に読み込ませる
- 既知判定の結果をGrafana等に連携

---

### 2. 既知ログの異常/正常判定（パラメータ抽出含む）
**要求**:
- 既知と判断されたもののうち、異常系か正常系かを判断
- 特定の異常を表す正規表現とマッチすれば異常
- 正規表現のパラメータ部分（例: `\d+ °C` の `\d+` が100の場合）について異常が認められる場合に異常
- そうでなければ正常
- この判断を行うテーブルを作成

**現在の実装状況**: ⚠️ **部分実装（70%）**

✅ **実装済み**:
- `log_params` テーブルと `ParamExtractor` により named capture から値を抽出
- `pattern_rules` テーブルを実装し、`add_threshold_rule.py` で設定可能
- `ingest.py` が既知ログに対して `AnomalyDetector` を呼び出し、`classification` を更新

❌ **未実装**:
- 既存自動パターンに named capture が含まれない（手動追加入力が必要）
- しきい値ルールの管理UIやエクスポート機能
- contains / regex ルールのテンプレ未整備

**必要な修正**:
- よく使うログへ named capture を導入
- ルール管理CLI/GUI（一覧・無効化・削除）
- しきい値テンプレをサンプルとして配布

---

### 3. 未知ログの手動マッピング
**要求**:
- 既知に分類されない（未知）ログについて
- 既知のログにほぼ同じような正規表現があれば、手動でその正規表現と対応させる
- 入力のログが入ったDBについて、既知フラグは立たなかったが、手動変更フラグを立て、対応する正規表現のIDと紐付ける

**現在の実装状況**: ✅ **実装済み（95%）**

✅ **実装済み**:
- `log_entries.is_manual_mapped` フラグを保持
- `cli_tools.py map-log` で未知ログを既知パターンに手動紐付け
- `update-label` コマンドでパターン全体の分類・severity を更新

⚠️ **追加で検討したい点**:
- 類似パターンをサジェストする支援ツール
- マッピング履歴の監査ログ

**今後の改善案**:
- `show-unknown` の出力に簡易サジェストを追加

---

### 4. 未知かつ正体不明ログのAI処理
**要求**:
- 上記全てに該当しない、つまり未知かつ正体不明のログについて
- 検索をかけたりgpt-ossなどのAIを利用したりして対処
- このエージェントはDBに自動格納することもできていてほしい

**現在の実装状況**: ❌ **未実装（0%）**

❌ **未実装**:
- AI（GPT-OSS等）への問い合わせ機能
- 検索機能
- AI分析結果のDB自動格納
- `ai_analyses` テーブルは定義されているが未使用

**必要な修正**:
- AI分析機能の実装
- `ai_analyses` テーブルの活用

---

### 5. 異常/正体不明ログのSlack通知
**要求**:
- 異常あるいは正体不明検知が行われた場合、Slackなどの外部ツールに連携

**現在の実装状況**: ✅ **実装済み（90%）**

✅ **実装済み**:
- `alerts` テーブルにアラート記録
- Slack Webhook への送信機能
- 送信成功/失敗の記録

⚠️ **改善点**:
- インジェスト時の自動送信（現在は別コマンドで実行）

---

## 実装状況サマリー

| 要求項目 | 実装状況 | 完了率 |
|---------|---------|--------|
| 1. 事前パターン登録と既知判定 | ほぼ実装済み | 90% |
| 2. 既知ログの異常/正常判定 | 部分実装 | 70% |
| 3. 未知ログの手動マッピング | 実装済み | 95% |
| 4. AI処理（未知かつ正体不明） | 未実装 | 0% |
| 5. Slack通知 | 実装済み | 90% |

**全体**: **約69% 実装完了**

---

## 必要な追加実装

### 優先すべき追加実装

1. **パラメータ抽出の充実**
   - 主要ログに named capture を追加し、`log_params` へ値を蓄積
   - しきい値テンプレの共有

2. **異常判定ルールの管理**
   - ルール一覧/削除/無効化を行うCLIやGUI
   - contains / regex ルールのプリセット化

3. **Slack通知の自動送信**
   - インジェスト完了後に `alerts` を即時送信するジョブ

4. **AI分析機能**
   - GPT等を利用した未知ログの説明生成
   - 結果を `ai_analyses` テーブル（新規作成）に保存

---

## 結論

現在の実装は**基本的なフローは実装済み**ですが、ユーザーが要求する詳細な機能（パラメータ抽出、異常判定の自動実行、手動マッピング、AI処理）は**まだ実装されていません**。

特に重要なのは：
- パラメータ抽出機能（`log_params` テーブル）
- 異常判定の自動実行（`pattern_rules` テーブル）
- 手動マッピング機能（`is_manual_mapped` フラグ）
- AI分析機能

これらを実装することで、要求フローを完全に満たすことができます。

